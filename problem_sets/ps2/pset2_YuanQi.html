<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yusn Qi">
<meta name="dcterms.date" content="2024-10-19">

<title>30538 Problem Set 2: Parking Tickets</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="pset2_YuanQi_files/libs/clipboard/clipboard.min.js"></script>
<script src="pset2_YuanQi_files/libs/quarto-html/quarto.js"></script>
<script src="pset2_YuanQi_files/libs/quarto-html/popper.min.js"></script>
<script src="pset2_YuanQi_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="pset2_YuanQi_files/libs/quarto-html/anchor.min.js"></script>
<link href="pset2_YuanQi_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="pset2_YuanQi_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="pset2_YuanQi_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="pset2_YuanQi_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="pset2_YuanQi_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">30538 Problem Set 2: Parking Tickets</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yusn Qi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 19, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<ol type="1">
<li>“This submission is my work alone and complies with the 30538 integrity policy.” Add your initials to indicate your agreement: **_YQ_**</li>
<li>“I have uploaded the names of anyone I worked with on the problem set <strong><a href="https://docs.google.com/forms/d/1-zzHx762odGlpVWtgdIC55vqF-j3gqdAp6Pno1rIGK0/edit">here</a></strong>” **_Yes_** (1 point)</li>
<li>Late coins used this pset: **_0_<em>* Late coins left after submission: **_3_</em>*</li>
<li>Knit your <code>ps1.qmd</code> to make <code>ps1.pdf</code>.
<ul>
<li>The PDF should not be more than 25 pages. Use <code>head()</code> and re-size figures when appropriate.</li>
</ul></li>
<li>Push <code>ps1.qmd</code> and <code>ps1.pdf</code> to your github repo. It is fine to use Github Desktop.</li>
<li>Submit <code>ps1.pdf</code> via Gradescope (4 points)</li>
<li>Tag your submission in Gradescope</li>
</ol>
<div id="d56fa079" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>alt.renderers.enable(<span class="st">"png"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-cleaning-continued-15-points" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning-continued-15-points">Data cleaning continued (15 points)</h2>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section">1.</h3>
<div id="f7678963" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> <span class="vs">r"C:\Users\freya\Desktop\24 fall study\Python2\Pset2\parking_tickets_one_percent.csv"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>pt <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a function to count the number of NA rows for each column</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_na(df):</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  na_count <span class="op">=</span> df.isna().<span class="bu">sum</span>()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert a dictionary to a dataframe</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  result_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Variable"</span>: na_count.index,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Count of NA"</span>: na_count.values</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result_df</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the numbers of NA row in the parking ticket dataset</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(count_na(pt))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Variable  Count of NA
0              Unnamed: 0            0
1           ticket_number            0
2              issue_date            0
3      violation_location            0
4    license_plate_number            0
5     license_plate_state           97
6      license_plate_type         2054
7                 zipcode        54115
8          violation_code            0
9   violation_description            0
10                   unit           29
11       unit_description            0
12           vehicle_make            0
13     fine_level1_amount            0
14     fine_level2_amount            0
15     current_amount_due            0
16         total_payments            0
17           ticket_queue            0
18      ticket_queue_date            0
19           notice_level        84068
20    hearing_disposition       259899
21          notice_number            0
22                officer            0
23                address            0</code></pre>
</div>
</div>
</section>
<section id="section-1" class="level3">
<h3 class="anchored" data-anchor-id="section-1">2.</h3>
<p>The most frequently data missing variables are hearing_disposition, notice_level and zipcode.</p>
<p>hearing_disposition reflects the outcome of the hearing. Liable means the defendant has been found responsible for the violation, while Not Liable indicates the defendant successfully presented a defense and was not found in violation. The missing data in this variable is largely due to many tickets were not contested.</p>
<p>notice_level describes the type of notice the city has sent a motorist. A lot of missing data is due to the drivers pay the fine immediately so no notice was sent.</p>
<p>zipz_code is the ZIP code associated with the vehicle registration.The missing zip code accompanies with missing notice level and probably related to the the missing the notice_level.</p>
</section>
<section id="section-2" class="level3">
<h3 class="anchored" data-anchor-id="section-2">3.</h3>
<div id="88112917" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter rows where 'violation_description' contains 'NO CITY STICKER'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>filtered_violations <span class="op">=</span> pt[pt[<span class="st">'violation_description'</span>].<span class="bu">str</span>.contains(<span class="st">'NO CITY STICKER'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Extract the year of issue date</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>filtered_violations[<span class="st">'year'</span>] <span class="op">=</span> pd.to_datetime(filtered_violations[<span class="st">'issue_date'</span>]).dt.year</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculte the unique violation code by year</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>violation_code_year <span class="op">=</span> filtered_violations.groupby(<span class="st">'year'</span>)[<span class="st">'violation_code'</span>].unique()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the unique violation_code by year</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_code_year)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the counts of differnt violation code</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>violation_code_description_counts <span class="op">=</span> filtered_violations.groupby([<span class="st">'violation_code'</span>,<span class="st">'violation_description'</span>]).size().reset_index(name<span class="op">=</span><span class="st">'counts'</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the unique violation_code, corresponding violation_description, and their counts</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_code_description_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>year
2007               [0964125, 0976170]
2008               [0964125, 0976170]
2009               [0964125, 0976170]
2010               [0964125, 0976170]
2011               [0964125, 0976170]
2012    [0964125, 0964125B, 0964125C]
2013             [0964125B, 0964125C]
2014             [0964125B, 0964125C]
2015             [0964125B, 0964125C]
2016             [0964125B, 0964125C]
2017             [0964125B, 0964125C]
2018                       [0964125B]
Name: violation_code, dtype: object
  violation_code                              violation_description  counts
0        0964125                NO CITY STICKER OR IMPROPER DISPLAY   10758
1       0964125B  NO CITY STICKER VEHICLE UNDER/EQUAL TO 16,000 ...   14246
2       0964125C           NO CITY STICKER VEHICLE OVER 16,000 LBS.     131
3        0976170                NO CITY STICKER OR IMPROPER DISPLAY      15</code></pre>
</div>
</div>
<p>The old violation code before 2012 is 0964125 (with 15 counts of 0976170). The new one is 0964125B for vehicle under/equal to 16,000 LBS, and 0964125C for vehicle over 16,000 LBS.</p>
</section>
<section id="section-3" class="level3">
<h3 class="anchored" data-anchor-id="section-3">4.</h3>
<div id="957fcc9b" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the rows where 'violation_code' equals '0964125' and '0964125B'</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>violation_964125 <span class="op">=</span> pt[pt[<span class="st">'violation_code'</span>] <span class="op">==</span> <span class="st">'0964125'</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>violation_964125B <span class="op">=</span> pt[pt[<span class="st">'violation_code'</span>] <span class="op">==</span> <span class="st">'0964125B'</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the 'violation_code' and 'fine_level1_amount' columns and print the first few rows</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>violation_964125_fines <span class="op">=</span> violation_964125[[<span class="st">'violation_code'</span>, <span class="st">'fine_level1_amount'</span>]].head()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>violation_964125B_fines <span class="op">=</span> violation_964125B[[<span class="st">'violation_code'</span>, <span class="st">'fine_level1_amount'</span>]].head()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the result</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_964125_fines)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_964125B_fines)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    violation_code  fine_level1_amount
14         0964125                 120
29         0964125                 120
82         0964125                 120
97         0964125                 120
104        0964125                 120
       violation_code  fine_level1_amount
138604       0964125B                 200
138614       0964125B                 200
138624       0964125B                 200
138625       0964125B                 200
138631       0964125B                 200</code></pre>
</div>
</div>
<p>The initial fine under the old violation code is $120, and the cost of initial offese under the new violation code is $200.</p>
</section>
</section>
<section id="revenue-increase-from-missing-city-sticker-tickets-20-points" class="level2">
<h2 class="anchored" data-anchor-id="revenue-increase-from-missing-city-sticker-tickets-20-points">Revenue increase from “missing city sticker” tickets (20 Points)</h2>
<section id="section-4" class="level3">
<h3 class="anchored" data-anchor-id="section-4">1.</h3>
<div id="d038c81d" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert ticket issue date to datetime format</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>pt[<span class="st">'issue_date'</span>] <span class="op">=</span> pd.to_datetime(pt[<span class="st">'issue_date'</span>])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column combining both violation codes into a single category for city sticker tickets</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>pt[<span class="st">'combined_violation_code'</span>] <span class="op">=</span> pt[<span class="st">'violation_code'</span>].<span class="bu">apply</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="st">'City Sticker Violation'</span> <span class="cf">if</span> x <span class="kw">in</span> [<span class="st">'0964125'</span>, <span class="st">'0964125B'</span>] <span class="cf">else</span> x</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for rows where the combined violation code is for city sticker violations</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>city_sticker_tickets <span class="op">=</span> pt[pt[<span class="st">'combined_violation_code'</span>] <span class="op">==</span> <span class="st">'City Sticker Violation'</span>]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Creat a colomn for the year and the month</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>city_sticker_tickets[<span class="st">'issue_year_month'</span>] <span class="op">=</span> city_sticker_tickets[<span class="st">'issue_date'</span>].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the tickets of city stickers by group of months</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>monthly_tickets <span class="op">=</span> city_sticker_tickets.groupby(<span class="st">'issue_year_month'</span>).size().reset_index(name <span class="op">=</span> <span class="st">'ticket_count'</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(monthly_tickets)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the 'issue_year_month' column to string format</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>monthly_tickets[<span class="st">'issue_year_month'</span>] <span class="op">=</span> monthly_tickets[<span class="st">'issue_year_month'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the graph using Altair</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>chart1 <span class="op">=</span> alt.Chart(monthly_tickets).mark_area().encode(</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> alt.X(<span class="st">'issue_year_month:T'</span>,title<span class="op">=</span><span class="st">'Month'</span>,axis<span class="op">=</span>alt.Axis(tickCount<span class="op">=</span><span class="dv">20</span>)),</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> alt.Y(<span class="st">'ticket_count:Q'</span>,title <span class="op">=</span><span class="st">'Number of Tickets'</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Tickets of No City Stickers by Month'</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>chart1.show()</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>chart1.save(<span class="st">'chart1.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    issue_year_month  ticket_count
0            2007-01           160
1            2007-02           104
2            2007-03           161
3            2007-04           158
4            2007-05           126
..               ...           ...
132          2018-01           168
133          2018-02           119
134          2018-03           171
135          2018-04           153
136          2018-05            79

[137 rows x 2 columns]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-6-output-2.png" width="649" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="section-5" class="level3">
<h3 class="anchored" data-anchor-id="section-5">2.</h3>
<div id="b64eb3fb" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the tickets data of no city sticker</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>no_city_sticker_tickets <span class="op">=</span> pt[pt[<span class="st">'violation_description'</span>].<span class="bu">str</span>.contains(<span class="st">'NO CITY STICKER'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the fine of $120 and $200</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>fine_120 <span class="op">=</span> no_city_sticker_tickets[no_city_sticker_tickets[<span class="st">'fine_level1_amount'</span>] <span class="op">==</span> <span class="dv">120</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>fine_200 <span class="op">=</span> no_city_sticker_tickets[no_city_sticker_tickets[<span class="st">'fine_level1_amount'</span>] <span class="op">==</span> <span class="dv">200</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the earlist date when fine changes from 120 to 200 </span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>increase_date <span class="op">=</span> fine_200[<span class="st">'issue_date'</span>].<span class="bu">min</span>()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The fine amount increased from 120 to 200 on: </span><span class="sc">{</span>increase_date<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The fine amount increased from 120 to 200 on: 2012-02-25 02:00:00</code></pre>
</div>
</div>
<div id="f2a88589" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the price increase date</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>increase_date_str <span class="op">=</span> <span class="st">'2012-02-25'</span>  <span class="co"># The date when the fine increased from 120 to 200</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Original area chart</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>chart1 <span class="op">=</span> alt.Chart(monthly_tickets).mark_area().encode(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'issue_year_month:T'</span>, title<span class="op">=</span><span class="st">'Month'</span>, axis<span class="op">=</span>alt.Axis(tickCount<span class="op">=</span><span class="dv">20</span>)),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'ticket_count:Q'</span>, title<span class="op">=</span><span class="st">'Number of Tickets'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Tickets of No City Stickers by Month'</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Vertical line at the price increase date</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>price_increase_line <span class="op">=</span> alt.Chart(pd.DataFrame({<span class="st">'increase_date'</span>: [increase_date_str]})).mark_rule(color<span class="op">=</span><span class="st">'red'</span>).encode(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'increase_date:T'</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a text label to show the date</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>price_increase_label <span class="op">=</span> alt.Chart(pd.DataFrame({</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'increase_date'</span>: [increase_date_str],</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'label'</span>: [<span class="st">'Price Increase Date: 2012-02-25'</span>]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>})).mark_text(align<span class="op">=</span><span class="st">'left'</span>, dx<span class="op">=</span><span class="dv">5</span>, dy<span class="op">=-</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'red'</span>).encode(</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'increase_date:T'</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span><span class="st">'label'</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the area chart, vertical line, and text label</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>final_chart <span class="op">=</span> chart1 <span class="op">+</span> price_increase_line <span class="op">+</span> price_increase_label</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the final chart with the price increase line and label</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>final_chart.show()</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>final_chart.save(<span class="st">'chart_with_price_increase_label.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-8-output-1.png" width="649" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The page I checked for adjusting the axis labels is here, https://altair-viz.github.io/user_guide/customization.html#axes</p>
</section>
<section id="section-6" class="level3">
<h3 class="anchored" data-anchor-id="section-6">3.</h3>
<div id="6d588cf5" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the tickets data for 2011 and with violation description 'NO CITY STICKER OR IMPROPER DISPLAY'</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>tickets_issued_2011 <span class="op">=</span> pt[(pt[<span class="st">'issue_date'</span>].dt.year <span class="op">==</span> <span class="dv">2011</span>) <span class="op">&amp;</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                         (pt[<span class="st">'violation_code'</span>] <span class="op">==</span> <span class="st">'0964125'</span>)].shape[<span class="dv">0</span>]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the total revenue increased by the policy change</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>revenue_increased <span class="op">=</span> tickets_issued_2011<span class="op">*</span>(<span class="dv">200</span><span class="op">-</span><span class="dv">120</span>)<span class="op">*</span><span class="dv">100</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'The government projected they will raise the total revunue of $</span><span class="sc">{</span>revenue_increased<span class="op">/</span><span class="dv">1000000</span><span class="sc">}</span><span class="ss"> million anually.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The government projected they will raise the total revunue of $15.464 million anually.</code></pre>
</div>
</div>
</section>
<section id="section-7" class="level3">
<h3 class="anchored" data-anchor-id="section-7">4.</h3>
<div id="63977e40" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the tickets data in 2012</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>tickets_2013 <span class="op">=</span> pt[pt[<span class="st">'issue_date'</span>].dt.year <span class="op">==</span> <span class="dv">2013</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of tickets issued in 2013</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>tickets_issued_2013 <span class="op">=</span> tickets_2013[tickets_2013[<span class="st">'violation_code'</span>] <span class="op">==</span> <span class="st">'0964125B'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of tickets paid in 2013</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>tickets_paid_2013 <span class="op">=</span> tickets_2013[</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    (tickets_2013[<span class="st">'violation_code'</span>] <span class="op">==</span> <span class="st">'0964125B'</span>) <span class="op">&amp;</span> </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    (tickets_2013[<span class="st">'ticket_queue'</span>] <span class="op">==</span> <span class="st">'Paid'</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>].shape[<span class="dv">0</span>]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the repayment rate</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>repayment_rate_2013 <span class="op">=</span> (tickets_paid_2013 <span class="op">/</span> tickets_issued_2013)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Recalculate the the total revenue increased by the policy change</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>revenue_increased1 <span class="op">=</span> tickets_issued_2011 <span class="op">*</span> repayment_rate_2013 <span class="op">*</span> (<span class="dv">200</span> <span class="op">-</span> <span class="dv">120</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'The repayment rate in 2013 is </span><span class="sc">{</span>repayment_rate_2013<span class="sc">:.3f}</span><span class="ss">.'</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'And the government projected they will raise the total revunue of $</span><span class="sc">{</span>revenue_increased1<span class="op">/</span><span class="dv">1000000</span><span class="sc">:.3f}</span><span class="ss"> million anually.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The repayment rate in 2013 is 0.406.
And the government projected they will raise the total revunue of $6.277 million anually.</code></pre>
</div>
</div>
</section>
<section id="section-8" class="level3">
<h3 class="anchored" data-anchor-id="section-8">5.</h3>
<div id="bf99e794" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the ticket data for city stickers</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>city_sticker_tickets <span class="op">=</span> pt[pt[<span class="st">'combined_violation_code'</span>] <span class="op">==</span> <span class="st">'City Sticker Violation'</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exract the Year of the issue date</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>city_sticker_tickets[<span class="st">'issue_year'</span>] <span class="op">=</span> city_sticker_tickets[<span class="st">'issue_date'</span>].dt.year</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the city sticker tickets issued per year</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>tickets_issued <span class="op">=</span> city_sticker_tickets.groupby(<span class="st">'issue_year'</span>).size().reset_index(name <span class="op">=</span> <span class="st">'tickets_issued'</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for only paid tickets</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>paid_tickets <span class="op">=</span> city_sticker_tickets[city_sticker_tickets[<span class="st">'ticket_queue'</span>] <span class="op">==</span> <span class="st">'Paid'</span>]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the city sticker tickets paid per year</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>tickets_paid <span class="op">=</span> paid_tickets.groupby(<span class="st">'issue_year'</span>).size().reset_index(name<span class="op">=</span><span class="st">'tickets_paid'</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first few rows to confirm the data</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tickets Issued:</span><span class="ch">\n</span><span class="st">"</span>, tickets_issued.head())</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tickets Paid:</span><span class="ch">\n</span><span class="st">"</span>, tickets_paid.head())</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge issued and paid tickets into a single DataFrame</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>tickets_summary <span class="op">=</span> pd.merge(tickets_issued, tickets_paid, on<span class="op">=</span><span class="st">'issue_year'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN values in tickets_paid with 0 (in case some years had no payments)</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>tickets_summary[<span class="st">'tickets_paid'</span>].fillna(<span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the merged DataFrame to confirm column names</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tickets Summary After Merge:</span><span class="ch">\n</span><span class="st">"</span>, tickets_summary.head())</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the repayment per year</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>tickets_summary[<span class="st">'repayment_rate'</span>] <span class="op">=</span> tickets_summary[<span class="st">'tickets_paid'</span>] <span class="op">/</span> tickets_summary[<span class="st">'tickets_issued'</span>]</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tickets_summary)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the graph </span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>chart2 <span class="op">=</span> alt.Chart(tickets_summary).mark_line(point<span class="op">=</span><span class="va">True</span>).encode(</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'issue_year:O'</span>,</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'repayment_rate:Q'</span>,</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'issue_year'</span>, <span class="st">'repayment_rate'</span>]</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Repayment Rates for Missing City Sticker Tickets'</span>,</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a vertical line for the policy change date</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>policy_change_year <span class="op">=</span> <span class="dv">2012</span> </span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>policy_change_line <span class="op">=</span> alt.Chart(pd.DataFrame({<span class="st">'issue_year'</span>: [policy_change_year]})).mark_rule(color<span class="op">=</span><span class="st">'red'</span>).encode(</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'issue_year:O'</span>)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the line chart and the policy change line</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>final_chart1 <span class="op">=</span> chart2 <span class="op">+</span> policy_change_line</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>final_chart1.show()</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>final_chart1.save(<span class="st">'final chart 1.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tickets Issued:
    issue_year  tickets_issued
0        2007            2264
1        2008            2212
2        2009            2149
3        2010            1985
4        2011            1933
Tickets Paid:
    issue_year  tickets_paid
0        2007          1246
1        2008          1280
2        2009          1142
3        2010          1032
4        2011          1042
Tickets Summary After Merge:
    issue_year  tickets_issued  tickets_paid
0        2007            2264          1246
1        2008            2212          1280
2        2009            2149          1142
3        2010            1985          1032
4        2011            1933          1042
    issue_year  tickets_issued  tickets_paid  repayment_rate
0         2007            2264          1246        0.550353
1         2008            2212          1280        0.578662
2         2009            2149          1142        0.531410
3         2010            1985          1032        0.519899
4         2011            1933          1042        0.539058
5         2012            2192          1057        0.482208
6         2013            2567          1042        0.405921
7         2014            2025           778        0.384198
8         2015            2467          1002        0.406161
9         2016            2264           923        0.407686
10        2017            2256           835        0.370124
11        2018             690           139        0.201449</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-11-output-2.png" width="652" height="477" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="section-9" class="level3">
<h3 class="anchored" data-anchor-id="section-9">6.</h3>
<div id="faf63c7c" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of tickets issued in 2011 by violation type</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>tickets_issued_2011_by_viotype <span class="op">=</span> pt[pt[<span class="st">'issue_date'</span>].dt.year <span class="op">==</span> <span class="dv">2011</span>].groupby(<span class="st">'violation_description'</span>).size().reset_index(name<span class="op">=</span><span class="st">'tickets_issued_2011'</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of tickets paid in 2011 by violation type</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>tickets_paid_2011_by_viotype <span class="op">=</span> pt[(pt[<span class="st">'issue_date'</span>].dt.year <span class="op">==</span> <span class="dv">2011</span>) <span class="op">&amp;</span> (pt[<span class="st">'ticket_queue'</span>] <span class="op">==</span> <span class="st">'Paid'</span>)].groupby(<span class="st">'violation_description'</span>).size().reset_index(name<span class="op">=</span><span class="st">'tickets_paid_2011'</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the two dataframes on 'violation_description'</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>violation_summary <span class="op">=</span> pd.merge(tickets_issued_2011_by_viotype, tickets_paid_2011_by_viotype, on<span class="op">=</span><span class="st">'violation_description'</span>, how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill missing values for unpaid violations</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>violation_summary[<span class="st">'tickets_issued_2011'</span>] <span class="op">=</span> violation_summary[<span class="st">'tickets_issued_2011'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>violation_summary[<span class="st">'tickets_paid_2011'</span>] <span class="op">=</span> violation_summary[<span class="st">'tickets_paid_2011'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the repayment rate for 2011 by violation type</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>violation_summary[<span class="st">'repayment_rate_2011'</span>] <span class="op">=</span> (violation_summary[<span class="st">'tickets_paid_2011'</span>] <span class="op">/</span> violation_summary[<span class="st">'tickets_issued_2011'</span>]).fillna(<span class="dv">0</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate potential revenue based on issued tickets and repayment rate</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>violation_summary[<span class="st">'potential_revenue'</span>] <span class="op">=</span> violation_summary[<span class="st">'tickets_issued_2011'</span>] <span class="op">*</span> violation_summary[<span class="st">'repayment_rate_2011'</span>]</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by revenue potential and select the top 3 violation types</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>top_violations <span class="op">=</span> violation_summary.sort_values(by<span class="op">=</span><span class="st">'potential_revenue'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">3</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the columns and top violations</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_summary.columns)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top_violations)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by potential revenue and take the top 10 violation types</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>top_violations <span class="op">=</span> violation_summary.sort_values(by<span class="op">=</span><span class="st">'potential_revenue'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the bar chart for the top 10 violation types by potential revenue</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>chart3 <span class="op">=</span> alt.Chart(top_violations).mark_bar().encode(</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'violation_description:O'</span>, title<span class="op">=</span><span class="st">'Violation Type'</span>, sort<span class="op">=</span><span class="st">'-y'</span>),</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'potential_revenue:Q'</span>, title<span class="op">=</span><span class="st">'Potential Revenue'</span>),</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'violation_description'</span>, <span class="st">'potential_revenue'</span>]</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Top 10 Violation Types by Potential Revenue'</span>,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>chart3.show()</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>chart3.save(<span class="st">'chart3.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['violation_description', 'tickets_issued_2011', 'tickets_paid_2011',
       'repayment_rate_2011', 'potential_revenue'],
      dtype='object')
                       violation_description  tickets_issued_2011  \
9                  EXPIRED METER OR OVERSTAY                 4967   
10  EXPIRED PLATES OR TEMPORARY REGISTRATION                 4345   
65                           STREET CLEANING                 2810   

    tickets_paid_2011  repayment_rate_2011  potential_revenue  
9              4088.0             0.823032             4088.0  
10             2764.0             0.636133             2764.0  
65             2330.0             0.829181             2330.0  </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-12-output-2.png" width="658" height="634" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I would recommend that the City Clerk consider increasing the fines for EXPIRED METER OR OVERSTAY, EXPIRED PLATES OR TEMPORARY REGISTRATION, and STREET CLEANING violations. Based on my analysis of potential revenue, without factoring in price changes, I calculated the revenue by multiplying the number of tickets issued by the repayment rate using 2011 data. These three violations ranked highest when considering both the number of tickets issued and the repayment rate.</p>
</section>
</section>
<section id="headlines-and-sub-messages-20-points" class="level2">
<h2 class="anchored" data-anchor-id="headlines-and-sub-messages-20-points">Headlines and sub-messages (20 points)</h2>
<section id="section-10" class="level3">
<h3 class="anchored" data-anchor-id="section-10">1.</h3>
<div id="b15ff389" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the tickets issued and tickets paid for each violation type</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>violation_summary2 <span class="op">=</span> pt.groupby(<span class="st">'violation_description'</span>).agg(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    tickets_issued <span class="op">=</span> (<span class="st">'ticket_number'</span>,<span class="st">'count'</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    fraction_paid <span class="op">=</span> (<span class="st">'ticket_queue'</span>,<span class="kw">lambda</span> x: (x <span class="op">==</span> <span class="st">'Paid'</span>).mean()),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    fine_level_1 <span class="op">=</span>(<span class="st">'fine_level1_amount'</span>,<span class="st">'mean'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>).reset_index().sort_values(by<span class="op">=</span><span class="st">'tickets_issued'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_summary2.head(<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        violation_description  tickets_issued  fraction_paid  \
23   EXPIRED PLATES OR TEMPORARY REGISTRATION           44811       0.604361   
101                           STREET CLEANING           28712       0.811612   
90                 RESIDENTIAL PERMIT PARKING           23683       0.742262   
19   EXP. METER NON-CENTRAL BUSINESS DISTRICT           20600       0.792913   
81        PARKING/STANDING PROHIBITED ANYTIME           19753       0.705817   

     fine_level_1  
23      54.968869  
101     54.004249  
90      66.338302  
19      46.598058  
81      66.142864  </code></pre>
</div>
</div>
</section>
<section id="section-11" class="level3">
<h3 class="anchored" data-anchor-id="section-11">2.</h3>
<div id="8622b214" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for violation types that appear at least 100 times</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>violation_summary3 <span class="op">=</span> violation_summary2[violation_summary2[<span class="st">'tickets_issued'</span>] <span class="op">&gt;=</span> <span class="dv">100</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude the outlier with a high fine </span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>violation_summary3_filtered <span class="op">=</span> violation_summary3[violation_summary3[<span class="st">'fine_level_1'</span>] <span class="op">&lt;=</span> <span class="dv">300</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="21690186" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of fine amount vs. fraction of tickets paid</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>chart4_1 <span class="op">=</span> alt.Chart(violation_summary3_filtered).mark_circle(size<span class="op">=</span><span class="dv">60</span>).encode(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'fine_level_1:Q'</span>, title<span class="op">=</span><span class="st">'Fine Amount'</span>),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'fraction_paid:Q'</span>, title<span class="op">=</span><span class="st">'Fraction of Tickets Paid'</span>),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'violation_description'</span>, <span class="st">'fine_level_1'</span>, <span class="st">'fraction_paid'</span>]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Relationship between Fine Amount and Fraction of Tickets Paid'</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>chart4_1.show()</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>chart4_1.save(<span class="st">'chart4_1.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-15-output-1.png" width="647" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Headlines:</strong> The scatter is more densely distributed when the fine amount is below $80, with sparser distribution for fines above $80. Overall, lower fines are associated with a higher fraction of tickets paid.</p>
<p><strong>Sub-messages:</strong> Variance is smaller when the fine is below $80, and increases significantly for fines above $80.</p>
<div id="0f37abe2" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar chart of fine amounts vs. fraction of tickets paid</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>chart4_2 <span class="op">=</span> alt.Chart(violation_summary3_filtered).mark_bar().encode(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'fine_level_1:Q'</span>, title<span class="op">=</span><span class="st">'Fine Amount'</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'fraction_paid:Q'</span>, title<span class="op">=</span><span class="st">'Fraction of Tickets Paid'</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'violation_description'</span>,<span class="st">'fine_level_1'</span>,<span class="st">'fraction_paid'</span>]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Relationship between Fine Amount and Fraction of Tickets Paid'</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>chart4_2.show()</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>chart4_2.save(<span class="st">'chart4_2.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-16-output-1.png" width="647" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Headlines:</strong> There is a negative correlation between the fine amount and the fraction of tickets paid: as the fine decreases, the fraction of tickets paid increases.</p>
<p><strong>Sub-messages:</strong> The fraction of tickets paid is not evenly distributed across fine amounts. In the ranges of $80 to $90 and $160 to $200, no tickets were paid.</p>
<div id="d222d828" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bin and color plot  of fine amounts vs. fractions of ticket paid</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>chart4_3 <span class="op">=</span> alt.Chart(violation_summary3_filtered).mark_bar().encode(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    alt.X(<span class="st">'fine_level_1:Q'</span>, <span class="bu">bin</span><span class="op">=</span>alt.BinParams(maxbins<span class="op">=</span><span class="dv">20</span>)),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    alt.Y(<span class="st">'fraction_paid:Q'</span>, <span class="bu">bin</span><span class="op">=</span>alt.BinParams(maxbins<span class="op">=</span><span class="dv">20</span>)),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    alt.Color(<span class="st">'count()'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Relationship between Fine Amount and Fraction of Tickets Paid'</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>chart4_3.show()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>chart4_3.save(<span class="st">'chart4_2.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-17-output-1.png" width="763" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Headlines:</strong> The scatter is more densely distributed when the fine amount is below $80, with sparser distribution for fines above $80. Overall, lower fines are associated with a higher fraction of tickets paid.</p>
<p><strong>Sub-messages:</strong> There are some extremely dense clusters of violation types, such as when the fine amount is between $20 and $30 with a fraction of 0.55 to 0.6, and when the fine is between $50 and $60 with a fraction of 0.7 to 0.75.</p>
</section>
<section id="section-12" class="level3">
<h3 class="anchored" data-anchor-id="section-12">3.</h3>
<p>I would choose the bar chart of fine amount and fraction of tickets paid. This plot clearly demonstrates the negative correlation between fine amount and the fraction of tickets paid, more effectively than the other two plots. It shows that higher fines lead to a lower average fraction of tickets paid, providing insights similar to those a regression analysis would reveal.</p>
</section>
</section>
<section id="understanding-the-structure-of-the-data-and-summarizing-it-lecture-5-20-points" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-structure-of-the-data-and-summarizing-it-lecture-5-20-points">Understanding the structure of the data and summarizing it (Lecture 5, 20 Points)</h2>
<section id="section-13" class="level3">
<h3 class="anchored" data-anchor-id="section-13">1.</h3>
<div id="f2247ef9" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the data of unpaid fine</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>violation_summary4 <span class="op">=</span> pt[pt[<span class="st">'ticket_queue'</span>] <span class="op">!=</span> <span class="st">'Paid'</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creat a new colum fine_double to count if the unpaid fine is doubled</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>violation_summary4[<span class="st">'fine_double'</span>] <span class="op">=</span> np.where(violation_summary4[<span class="st">'fine_level2_amount'</span>] <span class="op">/</span> violation_summary4[<span class="st">'fine_level1_amount'</span>] <span class="op">&gt;=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the violation types where at least 100 citations not doubled</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>violation_summary4_filtered <span class="op">=</span> violation_summary4[violation_summary4[<span class="st">'fine_double'</span>] <span class="op">==</span> <span class="dv">0</span>] <span class="op">\</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                                .groupby(<span class="st">'violation_description'</span>) <span class="op">\</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                                .<span class="bu">filter</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(x) <span class="op">&gt;=</span> <span class="dv">100</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if all violation fine double if unpaid</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>all_double <span class="op">=</span> violation_summary4[<span class="st">'fine_double'</span>].<span class="bu">all</span>()  </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the number of not doubled fine citations by each violation type</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>violation_count <span class="op">=</span> violation_summary4_filtered.groupby(<span class="st">'violation_description'</span>).size().reset_index(name<span class="op">=</span><span class="st">'not_double_count'</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the increase of unpaid for each ticket</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>violation_summary4_filtered[<span class="st">'fine_increase'</span>] <span class="op">=</span> violation_summary4_filtered[<span class="st">'fine_level2_amount'</span>] <span class="op">-</span> violation_summary4_filtered[<span class="st">'fine_level1_amount'</span>]</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all the results</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"If all violations double in price: "</span>, all_double) </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_count)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_summary4_filtered[[<span class="st">'violation_description'</span>, <span class="st">'fine_level2_amount'</span>, <span class="st">'fine_level1_amount'</span>, <span class="st">'fine_increase'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>If all violations double in price:  False
                   violation_description  not_double_count
0   BLOCK ACCESS/ALLEY/DRIVEWAY/FIRELANE               180
1                  DISABLED PARKING ZONE               431
2                    PARK OR BLOCK ALLEY               799
3  SMOKED/TINTED WINDOWS PARKED/STANDING               306
                        violation_description  fine_level2_amount  \
67                        PARK OR BLOCK ALLEY                 250   
200                     DISABLED PARKING ZONE                 250   
430                       PARK OR BLOCK ALLEY                 250   
744                     DISABLED PARKING ZONE                 250   
805                     DISABLED PARKING ZONE                 250   
...                                       ...                 ...   
138358  SMOKED/TINTED WINDOWS PARKED/STANDING                 250   
138363  SMOKED/TINTED WINDOWS PARKED/STANDING                 250   
138364                  DISABLED PARKING ZONE                 250   
138464                    PARK OR BLOCK ALLEY                 250   
138465                    PARK OR BLOCK ALLEY                 250   

        fine_level1_amount  fine_increase  
67                     150            100  
200                    200             50  
430                    150            100  
744                    200             50  
805                    200             50  
...                    ...            ...  
138358                 250              0  
138363                 250              0  
138364                 200             50  
138464                 150            100  
138465                 150            100  

[1716 rows x 4 columns]</code></pre>
</div>
</div>
</section>
<section id="section-14" class="level3">
<h3 class="anchored" data-anchor-id="section-14">2.</h3>
<div id="75c4348d" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check which unique values are in the variable ticket_queue</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>unique_ticket_queue_values <span class="op">=</span> pt[<span class="st">'ticket_queue'</span>].unique()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(unique_ticket_queue_values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Paid' 'Notice' 'Define' 'Dismissed' 'Bankruptcy' 'Court' 'Hearing Req']</code></pre>
</div>
</div>
<p><strong>The expalnation of different notice levels:</strong> <strong><em>Initial Violation (VIOL):</em></strong> The first stage.</p>
<p><strong><em>Detriment (DETR):</em></strong> After a warning, moving to a more serious stage.</p>
<p><strong><em>Seizure (SEIZ):</em></strong> Vehicle seizure due to non-payment.</p>
<p><strong><em>Final Notice (FINL):</em></strong> The last notice before collections.</p>
<p><strong><em>Delinquent (DLS):</em></strong> Represents overdue fines or final stages.</p>
<p><strong><em>NA:</em></strong> The notice has been resloved</p>
<div id="138c97d4" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check which unique values are in the variable ticket_queue</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>unique_ticket_queue_values <span class="op">=</span> pt[<span class="st">'ticket_queue'</span>].unique()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(unique_ticket_queue_values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Paid' 'Notice' 'Define' 'Dismissed' 'Bankruptcy' 'Court' 'Hearing Req']</code></pre>
</div>
</div>
<p><strong>The Explanation of these different values:</strong> <strong><em>Paid:</em></strong> The ticket has been paid, and the case is resolved.</p>
<p><strong><em>Notice:</em></strong> The violator has been notified of the ticket, awaiting payment or further action. This is the initial state of the ticket.</p>
<p><strong><em>Define:</em></strong> Further clarification or action is required, possibly waiting for more information or processing steps.</p>
<p><strong><em>Dismissed:</em></strong> The ticket has been dismissed, and the case is closed. Typically, this occurs when the violator is found not liable.</p>
<p><strong><em>Bankruptcy:</em></strong> The violator has declared bankruptcy, which may affect how the ticket is processed or collected.</p>
<p><strong><em>Court:</em></strong> The case has escalated to court for legal action and resolution.</p>
<p><strong><em>Hearing Req:</em></strong> The violator has requested a hearing to dispute the ticket, initiating a legal process.</p>
<p>So the diagrams of the process of moving between different notice levels and ticket queue levels are as below,</p>
<p><img src="diagram1_2.jpg" alt="Diagram for both variables" width="500"></p>
</section>
<section id="section-15" class="level3">
<h3 class="anchored" data-anchor-id="section-15">3.</h3>
<div id="174a038f" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the top 10 most common violation descriptions</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>top_10_violation_descriptions <span class="op">=</span> (</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    violation_summary3_filtered[<span class="st">'violation_description'</span>]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    .value_counts()</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">10</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    .index.tolist()</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column to mark whether the violation is in the top 10, otherwise label as "Other"</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>violation_summary3_filtered[<span class="st">'violation_group'</span>] <span class="op">=</span> violation_summary3_filtered[<span class="st">'violation_description'</span>].<span class="bu">apply</span>(</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x <span class="cf">if</span> x <span class="kw">in</span> top_10_violation_descriptions <span class="cf">else</span> <span class="st">'Other'</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e3960a97" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the scatter plot and implement both methods</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Method 1: Label every dot and mark other categories as "Other"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>chart5 <span class="op">=</span> alt.Chart(violation_summary3_filtered).mark_circle(size<span class="op">=</span><span class="dv">60</span>).encode(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'fine_level_1:Q'</span>, title<span class="op">=</span><span class="st">'Fine Amount'</span>),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'fraction_paid:Q'</span>, title<span class="op">=</span><span class="st">'Fraction of Tickets Paid'</span>),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>alt.Color(<span class="st">'violation_group:N'</span>, title<span class="op">=</span><span class="st">'Violation Description'</span>),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'violation_description'</span>, <span class="st">'fine_level_1'</span>, <span class="st">'fraction_paid'</span>]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Relationship between Fine Amount and Fraction of Tickets Paid'</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>).interactive()</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text label adjacent</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> chart5.mark_text(align <span class="op">=</span> <span class="st">'left'</span>, dx <span class="op">=</span> <span class="dv">5</span>, dy <span class="op">=</span> <span class="op">-</span><span class="dv">5</span>).encode(</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> <span class="st">'violation_group'</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the label and the chart</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>chart5_final <span class="op">=</span> chart5 <span class="op">+</span> text</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>chart5_final.show()</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>chart5_final.save(<span class="st">'chart5_final.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-22-output-1.png" width="840" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cba76c8a" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Method 2: Construct categories by marking violation descriptions which sound similar with a common label and a common color</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dictionary to map each violation description to a category</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>violation_category_mapping <span class="op">=</span> {</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RESIDENTIAL PERMIT PARKING'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PARKING/STANDING PROHIBITED ANYTIME'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NO STANDING/PARKING TIME RESTRICTED'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PARK OR BLOCK ALLEY'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RUSH HOUR PARKING'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'STREET CLEANING'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PARK OR STAND ON SIDEWALK'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NO CITY STICKER OR IMPROPER DISPLAY'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PARK OR STAND ON CROSSWALK'</span>: <span class="st">'Parking'</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EXPIRED PLATES OR TEMPORARY REGISTRATION'</span>: <span class="st">'Registration'</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EXPIRED METER CENTRAL BUSINESS DISTRICT'</span>: <span class="st">'Registration'</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EXPIRED METER NON-CENTRAL BUSINESS DISTRICT'</span>: <span class="st">'Registration'</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NONCOMPLIANT PLATE(S)'</span>: <span class="st">'Registration'</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'IMPROPER DISPLAY OF CITY STICKER'</span>: <span class="st">'Registration'</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WITHIN 15</span><span class="ch">\'</span><span class="st"> OF FIRE HYDRANT'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TRUCK,RV,BUS, OR TAXI RESIDENTIAL STREET'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TRUCK OR SEMI-TRAILER PROHIBITED'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BLOCK ACCESS/ALLEY/DRIVEWAY/FIRELANE'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SAFETY BELTS REQUIRED'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ABANDONED VEHICLE FOR 7 DAYS OR INOPERABLE'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HAZARDOUS DILAPIDATED VEHICLE'</span>: <span class="st">'Safety'</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SPECIAL EVENTS RESTRICTION'</span>: <span class="st">'Special Event'</span>,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PARK/STAND IN WRIGLEY BUS PERMIT ZONE'</span>: <span class="st">'Special Event'</span>,</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'THEATER ENTRANCE/EXIT'</span>: <span class="st">'Special Event'</span>,</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remaining as 'Other'</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the mapping to the dataset</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>violation_summary3_filtered[<span class="st">'violation_category'</span>] <span class="op">=</span> violation_summary3_filtered[<span class="st">'violation_description'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: violation_category_mapping.get(x, <span class="st">'Other'</span>))</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the scatter plot</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>chart6 <span class="op">=</span> alt.Chart(violation_summary3_filtered).mark_circle(size<span class="op">=</span><span class="dv">60</span>).encode(</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'fine_level_1:Q'</span>, title<span class="op">=</span><span class="st">'Fine Amount'</span>),</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'fraction_paid:Q'</span>, title<span class="op">=</span><span class="st">'Fraction of Tickets Paid'</span>),</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>alt.Color(<span class="st">'violation_category:N'</span>, title<span class="op">=</span><span class="st">'Violation Category'</span>),</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'violation_description'</span>, <span class="st">'fine_level_1'</span>, <span class="st">'fraction_paid'</span>]</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Relationship between Fine Amount and Fraction of Tickets Paid'</span>,</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>chart6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>
<figure class="figure">
<p><img src="pset2_YuanQi_files/figure-html/cell-23-output-1.png" width="761" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="extra-credit-max-5-points" class="level2">
<h2 class="anchored" data-anchor-id="extra-credit-max-5-points">Extra Credit (max 5 points)</h2>
<section id="section-16" class="level3">
<h3 class="anchored" data-anchor-id="section-16">1.</h3>
<div id="1657a5e8" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by violation_code and violation_description, and count occurrences</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>violation_grouped <span class="op">=</span> pt.groupby([<span class="st">'violation_code'</span>, <span class="st">'violation_description'</span>]).size().reset_index(name<span class="op">=</span><span class="st">'counts'</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(violation_grouped)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify violation codes associated with multiple descriptions</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>multiple_descriptions <span class="op">=</span> violation_grouped.groupby(<span class="st">'violation_code'</span>).size().reset_index(name<span class="op">=</span><span class="st">'description_count'</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>multiple_descriptions <span class="op">=</span> multiple_descriptions[multiple_descriptions[<span class="st">'description_count'</span>] <span class="op">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(multiple_descriptions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    violation_code                     violation_description  counts
0          0912060     STAND, PARK, OR OTHER USE OF BUS LANE    1233
1          0940060                PARK/STAND ON BICYCLE PATH     236
2          0940080  PARKED/STANDING UNATTENDED W/MOTOR RUNNI      81
3          0940170                          UNSAFE CONDITION      64
4          0940220                        NO OPERATOR SIGNAL      32
..             ...                                       ...     ...
119       0980120A                     NO PARK IN PUBLIC LOT     119
120       0980120B                    NO PARK IN PRIVATE LOT     378
121       0980130A  FAIL TO PAY OR OUTSIDE SPACE IN CITY LOT      90
122       0980130B              PARK IN CITY LOT WHEN CLOSED     225
123       0980130C             PARK IN CITY LOT OVER 30 DAYS       9

[124 rows x 3 columns]
    violation_code  description_count
9         0964040B                  2
11        0964041B                  2
17         0964070                  2
57        0964170D                  2
63        0964200B                  2
90        0976160A                  2
91        0976160B                  2
110       0980110B                  2</code></pre>
</div>
</div>
<div id="67ccf35e" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by violation_code and get the most frequent violation description</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>most_common_description <span class="op">=</span> violation_grouped.sort_values([<span class="st">'violation_code'</span>, <span class="st">'counts'</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the most common description for each violation code</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>most_common_description <span class="op">=</span> most_common_description.groupby(<span class="st">'violation_code'</span>).first().reset_index()</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the most common descriptions back into the original dataframe</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>pt <span class="op">=</span> pt.merge(most_common_description[[<span class="st">'violation_code'</span>, <span class="st">'violation_description'</span>]], on<span class="op">=</span><span class="st">'violation_code'</span>, suffixes<span class="op">=</span>(<span class="st">''</span>, <span class="st">'_most_common'</span>))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the top three codes with the most observations</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>top_three_codes <span class="op">=</span> most_common_description.nlargest(<span class="dv">3</span>, <span class="st">'counts'</span>)[[<span class="st">'violation_code'</span>, <span class="st">'counts'</span>]]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top_three_codes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   violation_code  counts
94       0976160F   44811
9        0964040B   28712
20       0964090E   23683</code></pre>
</div>
</div>
</section>
<section id="section-17" class="level3">
<h3 class="anchored" data-anchor-id="section-17">2.</h3>
<p><img src="visualization.png" alt="Diagram for both variables" width="500"> <img src="visualization_1.png" alt="Diagram for both variables" width="500"></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>